### Code for loading model predicitons from both shp and gdb inputs
### Used in create_spdf_gis_shp() and create_spdf_gis_gdb()

withProgress(message = "Adding model predictions to app", value = 0.3, {
  ### Check long extent, polygon validity, and generate crs.ll version if nec
  gis.file <- check_dateline(gis.file, progress.detail = TRUE)
  gis.file <- check_valid(gis.file, progress.detail = TRUE)
  sf.list <- gis_model_check(gis.file)
  incProgress(0.4)

  ### Process spatial data
  sf.load.ll   <- sf.list[[1]]
  sf.load.orig <- sf.list[[2]]


  weight.idx <- ifelse(weight.idx == 1, NA, weight.idx - 1)
  if(!is.na(weight.idx)) {
    toadd.w <- st_set_geometry(sf.load.ll, NULL)[, weight.idx]
  } else {
    toadd.w <- as.numeric(NA)
  }


  # Names of sf object columns set in ...create_local code
  sf.load.ll <- sf.load.ll %>% st_set_geometry(NULL) %>%
    dplyr::select(pred.idx) %>%
    dplyr::mutate(toadd.w, 1:nrow(sf.load.ll)) %>%
    st_sf(geometry = st_geometry(sf.load.ll), agr = "constant")

  sf.load.orig <- sf.load.orig %>% st_set_geometry(NULL) %>%
    dplyr::select(pred.idx) %>%
    dplyr::mutate(toadd.w, 1:nrow(sf.load.orig)) %>%
    st_sf(geometry = st_geometry(sf.load.orig), agr = "constant")
  incProgress(0.1)

  # Calculate resolution of the model predictions
  model.res <- gis_res_calc(sf.load.ll, sf.load.orig)
  incProgress(0.2)

  # Need names from sf.list[[1]] since sf.load.ll names will be different
  data.names <- list(names(sf.list[[1]])[c(pred.idx, weight.idx)])


  ###### Code common to raster and gis_shp/gis_gdb functions ######
  source("server_1_loadModels_create_local.R",
         local = TRUE, echo = FALSE, chdir = TRUE)
  #################################################################
})
